https://go.dev/play/p/y5ZGZ-la8Z6

old even shape

detail.decisionOutcomeContextItems[0].decisionOutcomeId
detail.decisionOutcomeRequestContext

new event shape

detail.decisionOutcomeId
detail.decisionOutcomeRequestId


old rule

{
  "eventPattern": {
    "source": ["us-east-1"],
    "detail": {
      "eventType": [{ "prefix": "concernExpired" }]
    }
  },
  "targetRegion": "us-east-1",
  "InputTransformer": {
    "InputPathsMap": {
      "decisionOutcomeRequestContext": "$.detail.decisionOutcomeRequestContext",
      "decisionOutcomeId": "$.detail.decisionOutcomeContextItems[0].decisionOutcomeId"
    },
    "InputTemplate": "{\"sourceSystem\":\"test-event-scheduler\",\"decisionOutcomeRequestContext\":<decisionOutcomeRequestContext>,\"decisionOutcomeContextItems\":[{\"decisionOutcomeId\":\"<decisionOutcomeId>\",\"decisionOutcomeItems\":[{\"key\":\"concernResult\",\"value\":\"EXPIRED\"}]}],\"workflowStageType\":\"CONCERN_CLOSED\"}"
  }
}


new rule
{
  "eventPattern": {
    "source": ["us-east-1"],
    "detail": {
      "eventType": [{ "prefix": "concernExpired" }],
      "decisionOutcomeId": [{ "exists": true }]
    }
  },
  "targetRegion": "us-east-1",
  "InputTransformer": {
    "InputPathsMap": {
      "decisionOutcomeId": "$.detail.decisionOutcomeId",
      "decisionOutcomeRequestId": "$.detail.decisionOutcomeRequestId"
    },
    "InputTemplate": "{\"sourceSystem\":\"event-scheduler\",\"decisionOutcomeRequestContext\":{\"decisionOutcomeRequestId\":\"<decisionOutcomeRequestId>\",\"decisionOutcomeRequestItems\":[]},\"decisionOutcomeContextItems\":[{\"decisionOutcomeId\":\"<decisionOutcomeId>\",\"decisionOutcomeItems\":[]}],\"workflowStageType\":\"CONCERN_CLOSED\"}"
  }
}

#Unit test changes
it('publishes new concernExpired event with messageId + flat fields', async () => {
  await processor.processNewEvent(input);

  expect(sendMock).toHaveBeenCalledWith(
    expect.objectContaining({
      detail: {
        eventType: 'concernExpired',
        messageId: expect.any(String),
        source: 'somesource',
        decisionOutcomeId: '123',
        decisionOutcomeRequestId: '456'
      }
    })
  );
});

#new test

function transformConcernClosed(detail: any) {
  return {
    sourceSystem: "event-scheduler",
    decisionOutcomeContextItems: [
      {
        decisionOutcomeId: detail.decisionOutcomeId,
        decisionOutcomeItems: []
      }
    ],
    decisionOutcomeRequestContext: {
      decisionOutcomeRequestId: detail.decisionOutcomeRequestId,
      decisionOutcomeRequestItems: []
    },
    workflowStageType: "CONCERN_CLOSED"
  };
}


test("new concernExpired event transforms correctly", () => {
  const detail = {
    eventType: "concernExpiredSomething",
    messageUUID: "abc-123",
    decisionOutcomeId: "DO-1",
    decisionOutcomeRequestId: "REQ-9"
  };

  const output = transformConcernClosed(detail);

  expect(output).toEqual({
    sourceSystem: "event-scheduler",
    decisionOutcomeContextItems: [
      {
        decisionOutcomeId: "DO-1",
        decisionOutcomeItems: []
      }
    ],
    decisionOutcomeRequestContext: {
      decisionOutcomeRequestId: "REQ-9",
      decisionOutcomeRequestItems: []
    },
    workflowStageType: "CONCERN_CLOSED"
  });
});


unit test still only
expect(sendMock).toHaveBeenCalledWith(
  expect.objectContaining({
    detail: expect.objectContaining({
      messageUUID: expect.any(String)
    })
  })
);

new rule
"detail": {
  "eventType": [{ "prefix": "concernExpired" }],
  "messageUUID": [{ "exists": true }]
}

"detail": {
  "eventType": [{ "prefix": "concernExpired" }]
}

