from playwright.sync_api import sync_playwright
import requests
import pdfplumber

DOCUMENT_ID = "12345"
PDF_FILENAME = "document.pdf"
PAGE_URL = "https://your-document-page.com"

with sync_playwright() as p:
    browser = p.chromium.launch(headless=False)  # set True for headless
    page = browser.new_page()
    
    # Go to your document search page
    page.goto(PAGE_URL)

    # Fill in the document ID
    page.fill("#document_id", DOCUMENT_ID)  # Replace with actual selector

    # Click the search button
    page.click("#search_button")  # Replace with actual selector

    # Wait for search results to load
    page.wait_for_selector("a#view_pdf_link")  # Replace with actual selector

    # Get the PDF link
    pdf_url = page.get_attribute("a#view_pdf_link", "href")
    print("PDF URL:", pdf_url)

    # Download the PDF using requests
    response = requests.get(pdf_url)
    with open(PDF_FILENAME, "wb") as f:
        f.write(response.content)

    print("PDF downloaded successfully!")

    browser.close()

with pdfplumber.open(PDF_FILENAME) as pdf:
    text = ""
    for page in pdf.pages:
        text += page.extract_text() + "\n"

print("Extracted PDF text:")
print(text)

editable = page.locator("input, textarea, [contenteditable=true]")
print("editable count:", editable.count())

for i in range(editable.count()):
    el = editable.nth(i)
    print({
        "tag": el.evaluate("e => e.tagName"),
        "type": el.get_attribute("type"),
        "visible": el.is_visible(),
        "class": el.get_attribute("class"),
    })



//Arnab
frame = page.frame_locator("iframe")

# find *any* editable input
search_input = frame.locator("input").filter(has_text="").first
search_input.fill("APPLICATION_ID_123")

frame.locator("button", has_text="Search").click()

with page.expect_response(lambda r: "search" in r.url and r.status == 200):
    frame.locator("button", has_text="Search").click()



docs_response = None

def is_docs_api(resp):
    return "documents" in resp.url and resp.status == 200

page.on("response", lambda r: globals().update(docs_response=r) if is_docs_api(r) else None)

page.goto(f"https://site/view?applicationId={app_id}")
page.wait_for_timeout(3000)


with page.expect_response(lambda r: "documents" in r.url):
    page.goto(f"https://site/view?applicationId={app_id}")

resp = page.expect_response
docs = resp.value.json()


[
  {
    "documentId": "abc123",
    "name": "Application Form",
    "type": "PDF"
  }
]

documents = docs.json()

for doc in documents:
    print(doc["documentId"], doc["name"])
pdf_urls = [
    f"https://site/api/document/{doc['documentId']}/pdf"
    for doc in documents
]



raw = resp.body()
text = raw.decode("utf-8", errors="replace")

print("URL:", resp.url)
print("Status:", resp.status)
print("Content-Type:", resp.headers.get("content-type"))
print("Encoding:", resp.headers.get("content-encoding"))
print("---- BODY START ----")
print(text[:30000])
print("---- BODY END ----")


//Arnab

with page.expect_response(
    lambda r: "/API/gallery-get-doc/" in r.url
) as resp_info:
    page.locator("button").filter(has_text="View").click()

resp = resp_info.value
print("Download URL:", resp.url)

2

pdf_resp = context.request.get(resp.url)

print(pdf_resp.status)
print(pdf_resp.headers.get("content-type"))

with open("document.pdf", "wb") as f:
    f.write(pdf_resp.body())


with open("document.pdf", "wb") as f:
    f.write(resp.body())


buttons = page.locator("button, [role=button], a")
print("Total clickable elements:", buttons.count())

for i in range(buttons.count()):
    el = buttons.nth(i)
    try:
        print(i, el.inner_text(), el.get_attribute("class"))
    except:
        pass

####
page.goto(view_page_url)
page.wait_for_load_state("networkidle")

frame = page.main_frame  # or correct iframe if needed

frame.wait_for_selector("button.viewDocButton")

with page.expect_response(
    lambda r: "gallery-get-doc" in r.url
) as resp_info:
    frame.locator("button.viewDocButton").first.click(force=True)

pdf_resp = resp_info.value

with open("document.pdf", "wb") as f:
    f.write(pdf_resp.body())

print("PDF downloaded successfully")






